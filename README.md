# Развертывание Gitea с помощью Ansible в Docker

## Описание проекта

Этот проект предназначен для автоматического развертывания Gitea (системы управления Git репозиториями) в Docker контейнере на целевом сервере с Debian 13. Для запуска используется Ansible, который сам работает внутри Docker контейнера.

## Структура проекта

```
.
├── Dockerfile                      # Файл для сборки Docker образа с Ansible
├── ansible/
│   ├── ansible.cfg                 # Конфигурация Ansible
│   ├── inventory.ini               # Список целевых серверов
│   └── deploy-gitea.yml            # Playbook для развертывания Gitea
└── README.md                       # Этот файл
```

## Что внутри

### Dockerfile
Docker образ на базе Debian 13 с установленным Ansible и необходимыми инструментами (openssh-client, sshpass, git).

### ansible/deploy-gitea.yml
Ansible playbook который:
- Устанавливает Docker на целевой сервер
- Создает директорию для данных Gitea
- Запускает Gitea в Docker контейнере
- Настраивает порты 80 (web) и 22 (ssh для git)


#### Шаг 1: Настройка inventory

Откройте файл `ansible/inventory.yml` и измените настройки на свои
1. **ansible_host - укажите ip адрес сервера***
2. **ansible_port - укажите порт для ssh подключения**
3. **ansible_user - укажите пользователя для ssh подключения**
4. **ansible_ssh_private_key_file - укажите путь к приватному ssh ключу**

```yml
all:
  children:
    gitea_servers:
      hosts:
        gitea-vm:
          ansible_host: 192.168.35.35
          ansible_port: 2222
          ansible_user: debian
          ansible_ssh_private_key_file: /ansible/.ssh/deb_gitea
          ansible_become: true
          ansible_become_method: sudo
          ansible_become_flags: -n

```
Ключ `deb_gitea` должен лежать в `ansible/.ssh/` на хостовой машине и пробрасываться в контейнер через `-v $(pwd)/ansible:/ansible`.

## Развертывание Gitea

### Шаг 1: Сборка Docker образа с Ansible

Перейдите в директорию проекта:

```bash
cd /path/to/gitea-ansible-task
```

Соберите Docker образ:

```bash
docker build -t ansible-debian:local .
```

Процесс займет несколько минут. Docker скачает базовый образ Debian 13 и установит Ansible с зависимостями.


### Шаг 2: Запуск Ansible из Docker контейнера

Для удаленного сервера (с SSH ключом):

```bash
docker run -it --rm \
  -v $(pwd)/ansible:/ansible \
  ansible-debian:local \
  ansible-playbook -i inventory.yml deploy-gitea.yml
```

### Шаг 3: Ожидание завершения

Ansible выполнит следующие действия:
1. Обновит кеш пакетов apt
2. Установит необходимые зависимости
3. Добавит официальный репозиторий Docker
4. Установит Docker
5. Создаст директорию для данных Gitea
6. Запустит контейнер Gitea
7. Дождется запуска сервиса

Процесс займет 5-10 минут в зависимости от скорости интернета.

### Шаг 5: Проверка развертывания

После успешного завершения откройте браузер и перейдите по адресу указанному в ansible/inventory.ini:

```
http://192.168.35.35
```


Вы должны увидеть страницу первоначальной настройки Gitea.

## Работа с Gitea

### Первоначальная настройка

При первом входе Gitea предложит настроить базу данных и административный аккаунт:

1. Выберите SQLite3 в качестве базы данных (по умолчанию)
2. Оставьте остальные настройки по умолчанию
3. Создайте административный аккаунт
4. Нажмите "Install Gitea"

### Работа с Git репозиториями

После настройки вы можете создавать репозитории и работать с ними через Git.

## Как это работает

### Docker образ с Ansible

Dockerfile создает образ на базе Debian 13 и устанавливает:
- `ansible` - система управления конфигурациями
- `openssh-client` - для SSH соединений с целевыми серверами
- `sshpass` - для аутентификации по паролю (для QEMU VM)
- `git` - на случай если понадобится клонировать репозитории

### Ansible Playbook

Playbook `deploy-gitea.yml` описывает последовательность действий:

1. **Обновление кеша пакетов** - гарантирует что установятся последние версии
2. **Установка зависимостей** - пакеты необходимые для добавления репозитория Docker
3. **Добавление GPG ключа Docker** - для проверки подлинности пакетов
4. **Добавление репозитория Docker** - официальный источник пакетов Docker
5. **Установка Docker** - из официального репозитория Docker (не из Debian)
6. **Запуск Docker** - активация сервиса и добавление в автозагрузку
7. **Создание директории** - `/opt/gitea` для хранения данных
8. **Остановка старого контейнера** - если Gitea уже был установлен
9. **Запуск Gitea** - создание и запуск контейнера с правильными портами и томом

### Переменные в Playbook

В начале playbook определены переменные:
- `gitea_version: "latest"` - использовать последнюю версию Gitea
- `gitea_http_port: "80"` - веб-интерфейс на 80 порту
- `gitea_ssh_port: "22"` - SSH для Git 
- `gitea_data_dir: "/opt/gitea"` - где хранятся данные

Вы можете изменить эти значения если нужны другие порты.

### Почему Docker внутри Docker

Ansible работает из Docker контейнера чтобы:
- Не засорять локальную систему зависимостями
- Иметь одинаковое окружение на любой машине
- Легко делиться проектом с коллегами

## Возможные проблемы и решения

### Проблема: Ansible не может подключиться к хосту

Решение:
- Проверьте что целевой хост доступен: `ping 192.168.35.35`
- Проверьте SSH доступ: `ssh debian@192.168.35.35`
- Проверьте правильность пароля/ключа в inventory.ini

### Проблема: `/bin/sh: 1: sudo: not found` (падает на Gathering Facts)

Причина: playbook запускается с `become: yes`, а на минимальной установке Debian `sudo` может быть не установлен. В итоге Ansible не может повысить привилегии и ломается ещё на сборе фактов.

Решение (на целевом хосте, Debian 13):

1) Зайдите на хост и получите root (например, в консоли VM):

```bash
ssh debian@192.168.35.35
su -
```

2) Установите `sudo` и добавьте пользователя в группу `sudo`:

```bash
apt update
apt install -y sudo
usermod -aG sudo debian
```

3) Перезайдите по SSH (чтобы подтянулись группы) и проверьте:

```bash
exit
ssh debian@192.168.35.35
sudo -n true || sudo true
```

### Проблема: Docker не устанавливается

Решение:
- Убедитесь что на целевом хосте Debian 13
- Проверьте доступ в интернет с целевого хоста
- Попробуйте вручную добавить репозиторий Docker

### Проблема: Порт 80 или 22 уже занят

Решение:
- Измените переменные в playbook на другие порты (например 8080 и 2222)
- Остановите службы занимающие эти порты на целевом хосте


## Дополнительные команды

### Проверка статуса Gitea на целевом хосте

```bash
ssh debian@192.168.35.35
sudo docker ps
sudo docker logs gitea
```

### Остановка Gitea

```bash
ssh debian@192.168.35.35
sudo docker stop gitea
```

### Запуск Gitea

```bash
ssh debian@192.168.35.35
sudo docker start gitea
```

### Повторный запуск playbook

Если что-то пошло не так, можно запустить playbook повторно - он идемпотентный (безопасно запускать много раз).

## Требования

### Локальная машина
- Linux с установленным Docker
- Доступ в интернет

### Целевой сервер
- Debian 13
- Минимум 1GB RAM
- Минимум 10GB свободного места на диске
- SSH доступ
- Доступ в интернет

## Автор

Viacheslav Karmazin проект создан в качестве тестового задания для позиции DevOps инженера.

**Полезные ресурсы:**

- [Документация Ansible](https://docs.ansible.com/)
- [Документация Docker](https://docs.docker.com/)
- [Документация Gitea](https://docs.gitea.io/)
- [Официальный сайт Debian](https://www.debian.org/)

---

> **Лицензия:** Этот проект предоставляется "как есть" для образовательных целей.